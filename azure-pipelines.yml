# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:


trigger:
- main

pool:
  name: Default

#container: docker.io/nginx:latest

steps:


- script: |
    git clone https://gitlab.com/Fx62/pokemones.git app
  displayName: 'Clone Rerpo'
- task: Npm@1
  inputs:
    command: 'install'
    workingDir: 'app'

- task: Npm@1
  inputs:
    command: 'custom'
    workingDir: 'app'
    customCommand: 'run build'


- script: |
    NAMESPACE=test-app-jandrade
    APPNAME=app
    VERSION=v5
    oc login ${OS_URL} -u ${USERNAME} -p ${PASSWORD} --insecure-skip-tls-verify=true
    oc project ${NAMESPACE}||oc new-project ${NAMESPACE}
    oc new-build --name ${APPNAME} --image-stream=openshift/nginx:1.20-ubi9 --binary --to=${APPNAME}:${VERSION} -o yaml|oc apply -f -
    oc start-build app  --from-dir . --follow
    oc create deployment ${APPNAME} --image=image-registry.svc:5000/${NAMESPACE}/${APPNAME}:${VERSION} --port 8080 -o yaml --dry-run=client|oc apply -f - 
    oc expose deployment ${APPNAME} -o yaml --dry-run=client   
    oc expose service ${APPNAME} -o yaml --dry-run=client |oc apply -f -

    

  displayName: 'Run a multi-line script'